// Copyright 2017 Vojtech Bubnik OK1IAK

#include <basic.h>

/*
graphics_toolkit('fltk');

len=32;
len=64
seq = (0.5:len-0.5) ./ len;
tone_start = (erf(seq .* 4 .- 2) .* 0.5 + 0.5) .* sin(seq .* (2*pi));
tone = sin(seq .* (2*pi));
tone_end = (erf(2 .- seq .* 4) .* 0.5 + 0.5) .* sin(seq .* (2*pi));
plot([tone_start, tone, tone_end]);
printf("    %4d,\n", round((tone_start.+1) .* (255/2)));
printf("    %4d,\n", round((tone.+1) .* (255/2)));
printf("    %4d,\n", round((tone_end.+1) .* (255/2)));

// long start / end sequences
seq2 = (0.5:2*len-0.5) ./ (2*len);
tone2_start = (erf(seq2 .* 4 .- 2) .* 0.5 + 0.5) .* sin(seq2 .* (4*pi));
tone2_end = (erf(2 .- seq2 .* 4) .* 0.5 + 0.5) .* sin(seq2 .* (4*pi));
plot([tone2_start, tone, tone2_end]);
printf("    %4d,\n", round((tone2_start.+1) .* (255/2)));
printf("    %4d,\n", round((tone2_end.+1) .* (255/2)));
*/

#if 0
const uint8 code tone_start_table[32] = {
     128,
     128,
     128,
     129,
     130,
     131,
     133,
     136,
     139,
     143,
     146,
     149,
     149,
     147,
     142,
     133,
     121,
     105,
      87,
      68,
      50,
      34,
      21,
      12,
       9,
      11,
      19,
      31,
      48,
      68,
      91,
     115,
};

const uint8 code tone_start_table2[64] = {
     128,
     128,
     128,
     128,
     128,
     129,
     129,
     129,
     130,
     130,
     131,
     131,
     131,
     131,
     130,
     128,
     126,
     124,
     121,
     117,
     112,
     108,
     103,
      99,
      95,
      93,
      92,
      93,
      97,
     103,
     111,
     121,
     134,
     148,
     163,
     178,
     192,
     205,
     215,
     222,
     226,
     225,
     220,
     211,
     197,
     181,
     161,
     139,
     116,
      93,
      70,
      50,
      32,
      18,
       8,
       3,
       3,
       7,
      16,
      30,
      47,
      68,
      91,
     115,
};

const uint8 code tone_table[32] = {
     140,
     165,
     188,
     208,
     226,
     240,
     250,
     254,
     254,
     250,
     240,
     226,
     208,
     188,
     165,
     140,
     115,
      90,
      67,
      47,
      29,
      15,
       5,
       1,
       1,
       5,
      15,
      29,
      47,
      67,
      90,
     115
};

const uint8 code tone_end_table[32] = {
     140,
     164,
     187,
     207,
     224,
     236,
     244,
     246,
     243,
     234,
     221,
     205,
     187,
     168,
     150,
     134,
     122,
     113,
     108,
     106,
     106,
     109,
     112,
     116,
     119,
     122,
     124,
     125,
     126,
     127,
     128,
     128,
};

const uint8 code tone_end_table2[64] = {
     140,
     164,
     187,
     208,
     225,
     239,
     248,
     252,
     252,
     247,
     237,
     223,
     205,
     185,
     162,
     139,
     116,
      94,
      74,
      58,
      44,
      35,
      30,
      29,
      33,
      40,
      50,
      63,
      77,
      92,
     107,
     121,
     134,
     144,
     152,
     158,
     162,
     163,
     162,
     160,
     156,
     152,
     147,
     143,
     138,
     134,
     131,
     129,
     127,
     125,
     124,
     124,
     124,
     124,
     125,
     125,
     126,
     126,
     126,
     127,
     127,
     127,
     128,
     128
};

#else
   
const uint8 code tone_start_table[64] = {
     128,
     128,
     128,
     128,
     128,
     128,
     128,
     129,
     129,
     130,
     131,
     132,
     133,
     134,
     135,
     137,
     138,
     140,
     142,
     144,
     145,
     147,
     148,
     149,
     149,
     149,
     148,
     146,
     144,
     140,
     136,
     131,
     124,
     117,
     109,
     101,
      92,
      82,
      73,
      64,
      54,
      46,
      37,
      30,
      24,
      18,
      14,
      11,
       9,
       9,
      10,
      13,
      16,
      21,
      27,
      35,
      43,
      52,
      63,
      73,
      85,
      97,
     109,
     121,
};

const uint8 code tone_start_table2[128] = {
     128,
     128,
     128,
     128,
     128,
     128,
     128,
     128,
     128,
     128,
     128,
     129,
     129,
     129,
     129,
     130,
     130,
     130,
     130,
     130,
     131,
     131,
     131,
     131,
     131,
     131,
     131,
     130,
     130,
     129,
     129,
     128,
     127,
     126,
     125,
     123,
     121,
     120,
     118,
     116,
     113,
     111,
     109,
     106,
     104,
     102,
     100,
      98,
      96,
      95,
      93,
      93,
      92,
      92,
      93,
      94,
      96,
      98,
     101,
     105,
     109,
     113,
     119,
     124,
     131,
     137,
     144,
     152,
     159,
     167,
     174,
     181,
     189,
     195,
     202,
     208,
     213,
     217,
     221,
     223,
     225,
     226,
     226,
     224,
     222,
     218,
     214,
     208,
     201,
     194,
     185,
     176,
     166,
     156,
     145,
     133,
     122,
     110,
      98,
      87,
      76,
      65,
      55,
      45,
      36,
      29,
      21,
      15,
      10,
       7,
       4,
       2,
       2,
       3,
       5,
       9,
      13,
      19,
      26,
      34,
      42,
      52,
      62,
      73,
      85,
      97,
     109,
     121,
};

const uint8 code tone_table[64] = {
     134,
     146,
     158,
     170,
     182,
     193,
     203,
     213,
     222,
     230,
     237,
     243,
     248,
     251,
     254,
     255,
     255,
     254,
     251,
     248,
     243,
     237,
     230,
     222,
     213,
     203,
     193,
     182,
     170,
     158,
     146,
     134,
     121,
     109,
      97,
      85,
      73,
      62,
      52,
      42,
      33,
      25,
      18,
      12,
       7,
       4,
       1,
       0,
       0,
       1,
       4,
       7,
      12,
      18,
      25,
      33,
      42,
      52,
      62,
      73,
      85,
      97,
     109,
     121,
};

const uint8 code tone_end_table[64] = {
     134,
     146,
     158,
     170,
     182,
     192,
     203,
     212,
     220,
     228,
     234,
     239,
     242,
     245,
     246,
     246,
     244,
     241,
     237,
     231,
     225,
     218,
     209,
     201,
     191,
     182,
     173,
     163,
     154,
     146,
     138,
     131,
     124,
     119,
     115,
     111,
     109,
     107,
     106,
     106,
     106,
     107,
     108,
     110,
     111,
     113,
     115,
     117,
     118,
     120,
     121,
     122,
     123,
     124,
     125,
     126,
     126,
     127,
     127,
     127,
     127,
     127,
     127,
     127,
};

const uint8 code tone_end_table2[128] = {
     134,
     146,
     158,
     170,
     182,
     193,
     203,
     213,
     221,
     229,
     236,
     242,
     246,
     250,
     252,
     253,
     253,
     251,
     248,
     245,
     240,
     234,
     226,
     219,
     210,
     200,
     190,
     179,
     168,
     157,
     145,
     133,
     122,
     110,
      99,
      89,
      79,
      70,
      61,
      54,
      47,
      41,
      37,
      33,
      31,
      29,
      29,
      30,
      32,
      34,
      38,
      42,
      47,
      53,
      60,
      66,
      74,
      81,
      88,
      96,
     103,
     111,
     118,
     124,
     131,
     136,
     142,
     146,
     150,
     154,
     157,
     159,
     161,
     162,
     163,
     163,
     162,
     162,
     160,
     159,
     157,
     155,
     153,
     151,
     149,
     146,
     144,
     142,
     139,
     137,
     135,
     134,
     132,
     130,
     129,
     128,
     127,
     126,
     126,
     125,
     125,
     124,
     124,
     124,
     124,
     124,
     124,
     124,
     125,
     125,
     125,
     125,
     125,
     126,
     126,
     126,
     126,
     127,
     127,
     127,
     127,
     127,
     127,
     127,
     127,
     127,
     127,
     127,
};

#endif

uint8 TONE_START_TD, TONE_RUN_TD, TONE_STOP_TD;

void Tone_Init(void) {
    VDAC8_TONE_Init();

    TONE_START_DmaInitialize(1, 1, HI16(CYDEV_FLS_BASE), HI16(CYDEV_PERIPH_BASE));
    TONE_START_TD = CyDmaTdAllocate();

    TONE_RUN_DmaInitialize(1, 1, HI16(CYDEV_FLS_BASE), HI16(CYDEV_PERIPH_BASE));
    TONE_RUN_TD = CyDmaTdAllocate();

    TONE_STOP_DmaInitialize(1, 1, HI16(CYDEV_FLS_BASE), HI16(CYDEV_PERIPH_BASE));
    TONE_STOP_TD = CyDmaTdAllocate();
}

void Tone_Start(void) {
    VDAC8_TONE_Start();

    CyDmaTdSetConfiguration(TONE_START_TD, sizeof(tone_start_table2), TONE_START_TD, CY_DMA_TD_INC_SRC_ADR | RxI2S_Stage__TD_TERMOUT_EN);
    CyDmaTdSetAddress(TONE_START_TD, LO16((uint32)tone_start_table2), LO16((uint32)VDAC8_TONE_Data_PTR));
    CyDmaClearPendingDrq(TONE_START_TD);
    CyDmaChSetInitialTd(TONE_START_DmaHandle, TONE_START_TD);

    CyDmaTdSetConfiguration(TONE_RUN_TD, sizeof(tone_table), TONE_RUN_TD, CY_DMA_TD_INC_SRC_ADR | RxI2S_Stage__TD_TERMOUT_EN);
    CyDmaTdSetAddress(TONE_RUN_TD, LO16((uint32)tone_table), LO16((uint32)VDAC8_TONE_Data_PTR));
    CyDmaClearPendingDrq(TONE_RUN_TD);
    CyDmaChSetInitialTd(TONE_RUN_DmaHandle, TONE_RUN_TD);

    CyDmaTdSetConfiguration(TONE_STOP_TD, sizeof(tone_end_table2), TONE_STOP_TD, CY_DMA_TD_INC_SRC_ADR | RxI2S_Stage__TD_TERMOUT_EN);
    CyDmaTdSetAddress(TONE_STOP_TD, LO16((uint32)tone_end_table2), LO16((uint32)VDAC8_TONE_Data_PTR));
    CyDmaClearPendingDrq(TONE_STOP_TD);
    CyDmaChSetInitialTd(TONE_STOP_DmaHandle, TONE_STOP_TD);
    
    CyDmaChEnable(TONE_START_DmaHandle, 1u);
    CyDmaChEnable(TONE_RUN_DmaHandle, 1u);
    CyDmaChEnable(TONE_STOP_DmaHandle, 1u);
}

void Tone_Stop(void) {
    CyDmaChDisable(TONE_START_DmaHandle);
    CyDmaChDisable(TONE_RUN_DmaHandle);
    CyDmaChDisable(TONE_STOP_DmaHandle);
    VDAC8_TONE_Stop();
}
