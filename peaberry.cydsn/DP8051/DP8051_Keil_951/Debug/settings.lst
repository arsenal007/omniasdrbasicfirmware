C51 COMPILER V9.51   SETTINGS                                                              10/24/2015 08:30:43 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE SETTINGS
OBJECT MODULE PLACED IN .\DP8051\DP8051_Keil_951\Debug\settings.obj
COMPILER INVOKED BY: C:\Program Files (x86)\Cypress\PSoC Creator\3.3\PSoC Creator\import\keil\pk51\9.51\C51\BIN\c51.exe 
                    -.\settings.c NOIV LARGE MODDP2 OMF2 VB(1) NOIP INCDIR(.,Generated_Source\PSoC3) FF(3) DB WL(2) PR(.\DP8051\DP8051_Keil_9
                    -51\Debug/settings.lst) CD OT(5,SIZE) OJ(.\DP8051\DP8051_Keil_951\Debug\settings.obj)

line level    source

   1          // Copyright 2013 David Turnbull AE9RB
   2          //
   3          // Licensed under the Apache License, Version 2.0 (the "License");
   4          // you may not use this file except in compliance with the License.
   5          // You may obtain a copy of the License at
   6          //
   7          //     http://www.apache.org/licenses/LICENSE-2.0
   8          //
   9          // Unless required by applicable law or agreed to in writing, software
  10          // distributed under the License is distributed on an "AS IS" BASIS,
  11          // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  12          // See the License for the specific language governing permissions and
  13          // limitations under the License.
  14          // 09/30/2014 Additions to support low latency CW and Iambic funtionality  Ron Patton / W4MMP
  15          // 01/01/2015 Added Semi Break-in Support Ron Patton / W4MMP
  16          
  17          #include <peaberry.h>
  18          
  19          #define XTAL_MIN (114.285 - 2)
  20          #define XTAL_MAX (114.285 + 2)
  21          
  22          uint8 buffer[CYDEV_EEPROM_ROW_SIZE];
  23          
  24          #define XTAL_DATA(mem) (*(reg32*)(mem+0))
  25          #define REVERSE_DATA(mem) (*(reg8*)(mem+4))
  26          
  27          void Settings_Init(void) {
  28   1          float crystal_freq;
  29   1          
  30   1          
  31   1          crystal_freq = ((float)swap32(*(reg32*)CYDEV_EE_BASE) / 0x01000000);
  32   1          
  33   1          if (
  34   1              crystal_freq < XTAL_MIN || crystal_freq > XTAL_MAX ||
  35   1              REVERSE_DATA(CYDEV_EE_BASE) > 3
  36   1          ) {
  37   2              // New radio! Si570_Start() will compute xtal
  38   2              // and it will immediately be stored in eeprom.
  39   2              Si570_Xtal = 0;
  40   2              Audio_IQ_Channels = 0;
  41   2          } else {
  42   2              Si570_Xtal = XTAL_DATA(CYDEV_EE_BASE);
  43   2              Audio_IQ_Channels = REVERSE_DATA(CYDEV_EE_BASE);
  44   2          }
  45   1          
  46   1      }
  47          
  48          void Settings_Main(void) {
  49   1          uint8 i;
  50   1          
  51   1          if (
  52   1              XTAL_DATA(CYDEV_EE_BASE) != Si570_Xtal ||
  53   1              REVERSE_DATA(CYDEV_EE_BASE) != Audio_IQ_Channels
C51 COMPILER V9.51   SETTINGS                                                              10/24/2015 08:30:43 PAGE 2   

  54   1          ) {
  55   2              if (EEPROM_QueryWrite() != CYRET_STARTED) {
  56   3                  for (i=4; i < CYDEV_EEPROM_ROW_SIZE; i++) buffer[i] = 0;
  57   3                  XTAL_DATA(buffer) = Si570_Xtal;
  58   3                  REVERSE_DATA(buffer) = Audio_IQ_Channels;
  59   3                  CySetTemp();
  60   3                  EEPROM_StartWrite(buffer, 0);
  61   3              }
  62   2          }
  63   1      
  64   1      }
C51 COMPILER V9.51   SETTINGS                                                              10/24/2015 08:30:43 PAGE 3   

ASSEMBLY LISTING OF GENERATED OBJECT CODE


             ; FUNCTION Settings_Init (BEGIN)
                                           ; SOURCE LINE # 27
                                           ; SOURCE LINE # 31
0000 908000            MOV     DPTR,#08000H
0003 120000      E     LCALL   ?C?LLDXDATA
0006 120000      E     LCALL   _?swap32
0009 E4                CLR     A
000A 120000      E     LCALL   ?C?FCASTL
000D E4                CLR     A
000E FB                MOV     R3,A
000F FA                MOV     R2,A
0010 7980              MOV     R1,#080H
0012 784B              MOV     R0,#04BH
0014 120000      E     LCALL   ?C?FPDIV
0017 900000      R     MOV     DPTR,#crystal_freq
001A 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 35
001D 7FEC              MOV     R7,#0ECH
001F 7E91              MOV     R6,#091H
0021 7DE0              MOV     R5,#0E0H
0023 7C42              MOV     R4,#042H
0025 900000      R     MOV     DPTR,#crystal_freq
0028 120000      E     LCALL   ?C?LLDXDATA0
002B 120000      E     LCALL   ?C?FPCMP3
002E 401E              JC      ?C0002
0030 7FEC              MOV     R7,#0ECH
0032 7E91              MOV     R6,#091H
0034 7DE8              MOV     R5,#0E8H
0036 7C42              MOV     R4,#042H
0038 900000      R     MOV     DPTR,#crystal_freq
003B 120000      E     LCALL   ?C?LLDXDATA0
003E 120000      E     LCALL   ?C?FPCMP3
0041 6002              JZ      $ + 4H
0043 5009              JNC     ?C0002
0045 908004            MOV     DPTR,#08004H
0048 E0                MOVX    A,@DPTR
0049 D3                SETB    C
004A 9403              SUBB    A,#03H
004C 4011              JC      ?C0001
004E         ?C0002:
                                           ; SOURCE LINE # 36
                                           ; SOURCE LINE # 39
004E E4                CLR     A
004F FF                MOV     R7,A
0050 FE                MOV     R6,A
0051 FD                MOV     R5,A
0052 FC                MOV     R4,A
0053 900000      E     MOV     DPTR,#Si570_Xtal
0056 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 40
0059 E4                CLR     A
005A 900000      E     MOV     DPTR,#Audio_IQ_Channels
005D F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 41
005E 22                RET     
005F         ?C0001:
                                           ; SOURCE LINE # 42
005F 908000            MOV     DPTR,#08000H
0062 120000      E     LCALL   ?C?LLDXDATA
C51 COMPILER V9.51   SETTINGS                                                              10/24/2015 08:30:43 PAGE 4   

0065 900000      E     MOV     DPTR,#Si570_Xtal
0068 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 43
006B 908004            MOV     DPTR,#08004H
006E E0                MOVX    A,@DPTR
006F 900000      E     MOV     DPTR,#Audio_IQ_Channels
0072 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 44
                                           ; SOURCE LINE # 46
0073         ?C0004:
0073 22                RET     
             ; FUNCTION Settings_Init (END)

             ; FUNCTION Settings_Main (BEGIN)
                                           ; SOURCE LINE # 48
                                           ; SOURCE LINE # 53
0000 900000      E     MOV     DPTR,#Si570_Xtal
0003 120000      E     LCALL   ?C?LLDXDATA
0006 908000            MOV     DPTR,#08000H
0009 120000      E     LCALL   ?C?LLDXDATA0
000C C3                CLR     C
000D 120000      E     LCALL   ?C?ULCMP
0010 700C              JNZ     ?C0006
0012 900000      E     MOV     DPTR,#Audio_IQ_Channels
0015 E0                MOVX    A,@DPTR
0016 FF                MOV     R7,A
0017 908004            MOV     DPTR,#08004H
001A E0                MOVX    A,@DPTR
001B 6F                XRL     A,R7
001C 6038              JZ      ?C0011
001E         ?C0006:
                                           ; SOURCE LINE # 54
                                           ; SOURCE LINE # 55
001E 120000      E     LCALL   EEPROM_Query
0021 EF                MOV     A,R7
0022 6407              XRL     A,#07H
0024 6030              JZ      ?C0011
                                           ; SOURCE LINE # 56
;---- Variable 'i' assigned to Register 'R7' ----
0026 7F04              MOV     R7,#04H
0028         ?C0008:
0028 7F0C              MOV     R7,#0CH
002A 900000      R     MOV     DPTR,#buffer+04H
002D E4                CLR     A
002E         ?C0012:
002E F0                MOVX    @DPTR,A
002F A3                INC     DPTR
0030 DFFC              DJNZ    R7,?C0012
0032 7F10              MOV     R7,#010H
0034         ?C0009:
                                           ; SOURCE LINE # 57
0034 900000      E     MOV     DPTR,#Si570_Xtal
0037 120000      E     LCALL   ?C?LLDXDATA
003A 900000      R     MOV     DPTR,#buffer
003D 120000      E     LCALL   ?C?LSTXDATA
                                           ; SOURCE LINE # 58
0040 900000      E     MOV     DPTR,#Audio_IQ_Channels
0043 E0                MOVX    A,@DPTR
0044 900000      R     MOV     DPTR,#buffer+04H
0047 F0                MOVX    @DPTR,A
                                           ; SOURCE LINE # 59
0048 120000      E     LCALL   CySetTemp
C51 COMPILER V9.51   SETTINGS                                                              10/24/2015 08:30:43 PAGE 5   

                                           ; SOURCE LINE # 60
004B 7B01              MOV     R3,#01H
004D 7A00        R     MOV     R2,#HIGH buffer
004F 7900        R     MOV     R1,#LOW buffer
0051 E4                CLR     A
0052 FD                MOV     R5,A
0053 120000      E     LCALL   _EEPROM_StartWrite
                                           ; SOURCE LINE # 61
                                           ; SOURCE LINE # 62
                                           ; SOURCE LINE # 64
0056         ?C0011:
0056 22                RET     
             ; FUNCTION Settings_Main (END)



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    203    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     16       4
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
